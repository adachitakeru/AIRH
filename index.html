<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3-Player Air Hockey</title>
    <script src="https://unpkg.com/peerjs@1.5.1/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/qrcode-generator@1.4.4/qrcode.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #1a1a1a;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
            color: white;
        }

        #game-container {
            position: relative;
            width: 800px;
            height: 800px;
        }

        canvas {
            background: #333;
            border-radius: 50%;
            border: 10px solid #444;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .score {
            position: absolute;
            font-size: 48px;
            font-weight: bold;
        }

        #score1 { top: 20px; left: 50%; transform: translateX(-50%); color: #ff4444; }
        #score2 { bottom: -80px; left: 20px; color: #44ff44; }
        #score3 { bottom: -80px; right: 20px; color: #4444ff; }

        #menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .menu-content {
            background: rgba(255,255,255,0.1);
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }

        #qr-code {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 8px;
            display: none;
        }

        .button {
            padding: 15px 30px;
            font-size: 18px;
            background: #4CAF50;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            margin: 10px;
        }

        #room-id {
            padding: 10px;
            font-size: 18px;
            width: 200px;
            margin: 10px;
        }

        #status {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            padding: 10px;
            border-radius: 4px;
        }

        #join-form {
            display: none;
        }

        #instructions {
            margin-top: 20px;
            font-size: 14px;
            color: #aaa;
        }
    </style>
</head>
<body>
    <div id="menu">
        <div class="menu-content">
            <h1>Air Hockey</h1>
            <button class="button" onclick="game.createGame()">Create Game</button>
            <button class="button" onclick="showJoinForm()">Join Game</button>
            <div id="join-form">
                <input type="text" id="room-id" placeholder="Enter Room Code">
                <button class="button" onclick="game.joinGame()">Join</button>
            </div>
            <div id="qr-code"></div>
            <div id="room-code-display"></div>
            <div id="instructions"></div>
        </div>
    </div>

    <div id="game-container">
        <canvas id="game-canvas" width="800" height="800"></canvas>
        <div class="score" id="score1">0</div>
        <div class="score" id="score2">0</div>
        <div class="score" id="score3">0</div>
    </div>

    <div id="status">Players: 1/3</div>

    <script>
        function showJoinForm() {
            document.getElementById('join-form').style.display = 'block';
        }

        class AirHockeyGame {
            constructor() {
                this.canvas = document.getElementById('game-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.width = this.canvas.width;
                this.height = this.canvas.height;

                this.peer = null;
                this.connections = {};
                this.players = {};
                this.playerId = null;
                this.roomId = null;
                this.isHost = false;

                this.gameState = {
                    puck: { x: this.width/2, y: this.height/2, dx: 0, dy: 0 },
                    scores: [0, 0, 0]
                };

                this.setupEventListeners();
                this.startGameLoop();
            }

            createGame() {
                this.isHost = true;
                this.playerId = 1;
                this.roomId = Math.random().toString(36).substring(2, 8).toUpperCase();

                // Generate QR Code
                const qr = qrcode(0, 'M');
                const gameUrl = `${window.location.href}?room=${this.roomId}`;
                qr.addData(gameUrl);
                qr.make();
                
                document.getElementById('qr-code').innerHTML = qr.createImgTag();
                document.getElementById('qr-code').style.display = 'block';
                document.getElementById('room-code-display').innerHTML = `Room Code: ${this.roomId}`;
                document.getElementById('instructions').innerHTML = 
                    'Share the QR code or room code with other players';

                // Initialize PeerJS connection
                this.peer = new Peer(`airhockey-${this.roomId}-1`);
                this.setupPeerCallbacks();
            }

            joinGame() {
                const roomId = document.getElementById('room-id').value.toUpperCase();
                if (!roomId) {
                    alert('Please enter a room code');
                    return;
                }

                this.roomId = roomId;
                this.playerId = Object.keys(this.connections).length + 2;
                
                // Initialize PeerJS connection
                this.peer = new Peer(`airhockey-${this.roomId}-${this.playerId}`);
                this.setupPeerCallbacks();
            }

            setupPeerCallbacks() {
                this.peer.on('open', (id) => {
                    if (!this.isHost) {
                        const conn = this.peer.connect(`airhockey-${this.roomId}-1`);
                        this.setupConnection(conn);
                    }
                    document.getElementById('menu').style.display = 'none';
                });

                this.peer.on('connection', (conn) => {
                    this.setupConnection(conn);
                });

                this.peer.on('error', (err) => {
                    console.error(err);
                    alert('Connection error. Please try again.');
                });
            }

            setupConnection(conn) {
                this.connections[conn.peer] = conn;

                conn.on('open', () => {
                    this.updatePlayerCount();
                    if (this.isHost) {
                        this.broadcastGameState();
                    }
                });

                conn.on('data', (data) => {
                    this.handleGameData(data);
                });

                conn.on('close', () => {
                    delete this.connections[conn.peer];
                    delete this.players[conn.peer];
                    this.updatePlayerCount();
                });
            }

            handleGameData(data) {
                switch(data.type) {
                    case 'playerPosition':
                        this.players[data.playerId] = data.position;
                        break;
                    case 'gameState':
                        if (!this.isHost) {
                            this.gameState = data.state;
                        }
                        break;
                }
            }

            broadcastGameState() {
                Object.values(this.connections).forEach(conn => {
                    conn.send({
                        type: 'gameState',
                        state: this.gameState
                    });
                });
            }

            updatePlayerCount() {
                const count = Object.keys(this.connections).length + 1;
                document.getElementById('status').textContent = `Players: ${count}/3`;
                
                if (count === 3) {
                    this.startGame();
                }
            }

            startGame() {
                document.getElementById('menu').style.display = 'none';
            }

            setupEventListeners() {
                this.canvas.addEventListener('mousemove', (e) => {
                    if (!this.playerId) return;

                    const rect = this.canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const pos = this.limitToPlayerSection(x, y);
                    this.players[this.peer.id] = pos;

                    Object.values(this.connections).forEach(conn => {
                        conn.send({
                            type: 'playerPosition',
                            playerId: this.playerId,
                            position: pos
                        });
                    });
                });
            }

            limitToPlayerSection(x, y) {
                const angle = (this.playerId - 1) * (2 * Math.PI / 3);
                const sectionWidth = 2 * Math.PI / 3;
                
                const center = { x: this.width/2, y: this.height/2 };
                const radius = this.width/2 - 50;

                const dx = x - center.x;
                const dy = y - center.y;
                let r = Math.sqrt(dx * dx + dy * dy);
                let theta = Math.atan2(dy, dx);
                
                if (theta < 0) theta += 2 * Math.PI;
                
                const minAngle = angle - sectionWidth/2;
                const maxAngle = angle + sectionWidth/2;
                
                theta = Math.max(minAngle, Math.min(maxAngle, theta));
                r = Math.min(r, radius);
                
                return {
                    x: center.x + r * Math.cos(theta),
                    y: center.y + r * Math.sin(theta)
                };
            }

            startGameLoop() {
                const loop = () => {
                    this.update();
                    this.draw();
                    requestAnimationFrame(loop);
                };
                loop();
            }

            update() {
                if (this.isHost) {
                    this.updatePuck();
                    this.checkCollisions();
                    this.checkScoring();
                    this.broadcastGameState();
                }
            }

            updatePuck() {
                const puck = this.gameState.puck;
                puck.x += puck.dx;
                puck.y += puck.dy;

                // Add friction
                puck.dx *= 0.99;
                puck.dy *= 0.99;

                // Bounce off walls
                const radius = this.width/2 - 10;
                const dx = puck.x - this.width/2;
                const dy = puck.y - this.height/2;
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance > radius) {
                    const angle = Math.atan2(dy, dx);
                    puck.x = this.width/2 + radius * Math.cos(angle);
                    puck.y = this.height/2 + radius * Math.sin(angle);

                    const normalX = Math.cos(angle);
                    const normalY = Math.sin(angle);
                    const dot = puck.dx * normalX + puck.dy * normalY;
                    puck.dx = puck.dx - 2 * dot * normalX;
                    puck.dy = puck.dy - 2 * dot * normalY;
                }
            }

            checkCollisions() {
                const puck = this.gameState.puck;
                
                Object.values(this.players).forEach(player => {
                    const dx = puck.x - player.x;
                    const dy = puck.y - player.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 30) {
                        const angle = Math.atan2(dy, dx);
                        const speed = 15;
                        puck.dx = Math.cos(angle) * speed;
                        puck.dy = Math.sin(angle) * speed;
                    }
                });
            }

            checkScoring() {
                const puck = this.gameState.puck;
                const dx = puck.x - this.width/2;
                const dy = puck.y - this.height/2;
                const angle = Math.atan2(dy, dx);
                const distance = Math.sqrt(dx * dx + dy * dy);

                if (distance > this.width/2 - 30) {
                    let scorer = null;
                    const normalizedAngle = (angle + 2 * Math.PI) % (2 * Math.PI);
                    
                    if (normalizedAngle < 2*Math.PI/3) scorer = 2;
                    else if (normalizedAngle < 4*Math.PI/3) scorer = 3;
                    else scorer = 1;

                    if (scorer) {
                        this.gameState.scores[scorer-1]++;
                        this.resetPuck();
                    }
                }
            }

            resetPuck() {
                this.gameState.puck = {
                    x: this.width/2,
                    y: this.height/2,
                    dx: 0,
                    dy: 0
                };
            }

            draw() {
                this.ctx.clearRect(0, 0, this.width, this.height);
                
                // Draw playing field
                this.ctx.beginPath();
                this.ctx.arc(this.width/2, this.height/2, this.width/2-20, 0, 2*Math.PI);
                this.ctx.strokeStyle = '#666';
                this.ctx.lineWidth = 5;
                this.ctx.stroke();
                
                // Draw sections
                for (let i = 0; i < 3; i++) {
                    const angle = i * (2*Math.PI/3);
                    this.ctx.beginPath();
                    this.ctx.moveTo(this.width/2, this.height/2);
                    this.ctx.lineTo(
                        this.width/2 + (this.width/2-20) * Math.cos(angle),
                        this.height/2 + (this.width/2-20) * Math.sin(angle)
                    );
                    this.ctx.stroke();
                }
                
                // Draw players
                
                
                
                
                Object.entries(this.players).forEach(([peerId, pos], index) => {
                    this.ctx.beginPath();
                    this.ctx.arc(pos.x, pos.y, 20, 0, 2*Math.PI);
                    this.ctx.fillStyle = index === 0 ? '#ff4444' : index === 1 ? '#44ff44' : '#4444ff';
                    this.ctx.fill();
                    
                    // Draw player numbers
                    this.ctx.fillStyle = 'white';
                    this.ctx.font = '16px Arial';
                    this.ctx.textAlign = 'center';
                    this.ctx.textBaseline = 'middle';
                    this.ctx.fillText(index + 1, pos.x, pos.y);
                });
                
                // Draw puck
                const puck = this.gameState.puck;
                this.ctx.beginPath();
                this.ctx.arc(puck.x, puck.y, 10, 0, 2*Math.PI);
                this.ctx.fillStyle = '#fff';
                this.ctx.fill();
                
                // Draw scores
                for (let i = 0; i < 3; i++) {
                    document.getElementById(`score${i+1}`).textContent = 
                        this.gameState.scores[i];
                }

                // Draw goal areas
                for (let i = 0; i < 3; i++) {
                    const angle = i * (2*Math.PI/3);
                    const startAngle = angle - Math.PI/6;
                    const endAngle = angle + Math.PI/6;
                    
                    this.ctx.beginPath();
                    this.ctx.arc(this.width/2, this.height/2, this.width/2-20, startAngle, endAngle);
                    this.ctx.strokeStyle = i === 0 ? '#ff4444' : i === 1 ? '#44ff44' : '#4444ff';
                    this.ctx.lineWidth = 8;
                    this.ctx.stroke();
                }
            }
        }

        // Check for room ID in URL when page loads
        window.onload = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const roomId = urlParams.get('room');
            
            window.game = new AirHockeyGame();
            
            if (roomId) {
                document.getElementById('room-id').value = roomId;
                game.joinGame();
            }
        };
    </script>
</body>
</html>
